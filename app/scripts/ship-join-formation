#!/var/hyperdrive/scripts/overseer
# vim: set ft=sh :
### Usage:
###   ship-join-formation <hull_name> 
### Options:
###   --help

# TODO: flock the inventory stuff

if ! hull_exists "${hull_name}"; then
  fatal "'${hull_name}' is not a valid hull name"
fi

IP_ADDRESS="$(ship_ip "${hull_name}")"
apply_order_exports "${HYPERDRIVE_LXC_ROOT}/${hull_name}/share/orders"
NAME="$(< "${HYPERDRIVE_LXC_ROOT}/${hull_name}/share/.name")"

# create the nginx manifest for the hull
MANIFEST="${HYPERDRIVE_NGINX}/manifests/${hull_name}.manifest"
touch "${MANIFEST}"

# create the upstream for the ship
UPSTREAM_FILE="${HYPERDRIVE_NGINX}/upstream/${hull_name}.conf"
trace "creating '${UPSTREAM_FILE}'"
echo "${UPSTREAM_FILE}" >> "${MANIFEST}"
cat << EOF > "${UPSTREAM_FILE}"
upstream ${hull_name} {
server ${IP_ADDRESS}:${PORT} max_fails=0;
}
EOF

# if a specific host is requested, we need to disable the default routing in nginx for that port
if [[ -n "${PUBLISH_HOST:-}" ]]; then
  OVERRIDE_FILE="${HYPERDRIVE_NGINX}/overrides/port-${PUBLISH_PORT}.conf"
  trace "creating '${OVERRIDE_FILE}'"
  echo "${OVERRIDE_FILE}" >> "${MANIFEST}"
cat << EOF > "${OVERRIDE_FILE}"
  server {
    listen      ${PUBLISH_PORT};
    server_name "";
    return      444;
  }
EOF
fi

HOST_FILE="${HYPERDRIVE_NGINX}/hosts/${hull_name}.conf"
trace "creating '${HOST_FILE}'"
echo "${HOST_FILE}" >> "${MANIFEST}"
cat << EOF > "${HOST_FILE}"
server {
  server_name ${PUBLISH_HOST:-};

  listen ${PUBLISH_PORT};

  location ${PUBLISH_ROOT:-/} {
    gzip on;
    gzip_types *;
    gzip_proxied any;
    gzip_comp_level 6;

    include cors.conf;

    proxy_set_header X-Forwarded-Host \$host;
    proxy_set_header X-Forwarded-Server \$host;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;

    # forward host header
    proxy_set_header Host \$http_host;

    # WebSocket support (nginx 1.4)
    proxy_http_version 1.1;
    proxy_set_header Upgrade \$http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://${hull_name};
  }
}
EOF
#rewrite /invite/(.*) /$1 break;

# cleanup
trace "deleting '${HYPERDRIVE_NGINX}/upstream/${NAME}-*.conf'"
rm -f ${HYPERDRIVE_NGINX}/upstream/${NAME}-*.conf

# TODO: fix
trace "removing '${HYPERDRIVE_NGINX}/overrides/port-${PUBLISH_PORT}.conf'"
rm -f "${HYPERDRIVE_NGINX}/overrides/port-${PUBLISH_PORT}.conf"
trace "deleting '${HYPERDRIVE_NGINX}/hosts/${NAME}-*.conf'"
rm -f ${HYPERDRIVE_NGINX}/hosts/${NAME}-*.conf

# done
info "ship '${hull_name}' joined formation"
