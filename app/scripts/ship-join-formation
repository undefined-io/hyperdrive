#!/var/hyperdrive/scripts/overseer
# vim: set ft=sh :
### Usage:
###   ship-join-formation <hull_name> 
### Options:
###   --help

if hull_exists "${hull_name}"; then

IP_ADDRESS="$(ship_ip "${hull_name}")"
apply_order_exports "${HYPERDRIVE_LXC_ROOT}/${hull_name}/share/orders"
NAME="$(< "${HYPERDRIVE_LXC_ROOT}/${hull_name}/share/.name")"

# create the upstream for the ship
trace "creating '${HYPERDRIVE_NGINX}/upstream/${hull_name}.conf'"
cat << EOF > "${HYPERDRIVE_NGINX}/upstream/${hull_name}.conf"
upstream ${hull_name} {
server ${IP_ADDRESS}:${PORT} max_fails=0;
}
EOF

# if a specific host is requested, we need to disable the default routing in nginx for that port
if [[ -n "${PUBLISH_HOST:-}" ]]; then
  trace "creating '${HYPERDRIVE_NGINX}/overrides/port-${PUBLISH_PORT}.conf'"
cat << EOF > "${HYPERDRIVE_NGINX}/overrides/port-${PUBLISH_PORT}.conf"
  server {
    listen      ${PUBLISH_PORT};
    server_name "";
    return      444;
  }
EOF
else
  trace "removing '${HYPERDRIVE_NGINX}/overrides/port-${PUBLISH_PORT}.conf'"
  rm -f "${HYPERDRIVE_NGINX}/overrides/port-${PUBLISH_PORT}.conf"
fi

trace "cleaning up previous '${NAME}' host configs"
rm -f "${HYPERDRIVE_NGINX}/hosts/${NAME}-*.conf"

trace "creating '${HYPERDRIVE_NGINX}/hosts/${hull_name}.conf'"
cat << EOF > "${HYPERDRIVE_NGINX}/hosts/${hull_name}.conf"
server {
  server_name ${PUBLISH_HOST:-};

  listen ${PUBLISH_PORT};

  location / {
    gzip on;
    gzip_types *;
    gzip_proxied any;
    gzip_comp_level 6;

    include cors.conf;

    proxy_set_header X-Forwarded-Host \$host;
    proxy_set_header X-Forwarded-Server \$host;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;

    # forward host header
    proxy_set_header Host \$http_host;

    # WebSocket support (nginx 1.4)
    proxy_http_version 1.1;
    proxy_set_header Upgrade \$http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://${hull_name};
  }
}
EOF

info "ship '${hull_name}' joined formation"

else

warn "'${hull_name}' is not a valid hull name"

fi # hull_exists

