#!/usr/bin/env bash
### Usage:
###   ship-launch <hull_name> 
### Options:
###   --help

#--HEAD--
# TODO: See if this can be added from a template
set -o nounset; set -o errexit; set -o pipefail
SCRIPT="$(test -L "$0" && readlink -e "$0" || readlink -e "$0")"
SCRIPT_NAME="$(basename "${SCRIPT}")"
SCRIPT_DIR="$(dirname "${SCRIPT}")"
source "${SCRIPT_DIR}/main.source"
#--/HEAD--

if hull_exists "${hull_name}"; then

IP_ADDRESS="$(ship_ip "${hull_name}")"
eval $(awk '/^[ \t]*export[ \t]+(PORT|PUBLISH_PORT)[ \t]*=/ {print $0}' "${HYPERDRIVE_LXC_ROOT}/${hull_name}/share/orders")
cat << EOF > "${HYPERDRIVE_NGINX}/upstream/${hull_name}.conf"
upstream ${hull_name} {
server ${IP_ADDRESS}:${PORT} max_fails=0;
}
EOF

fi
