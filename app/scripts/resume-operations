#!/var/hyperdrive/scripts/overseer
# vim: set ft=sh :
### Usage:
###   resume-operations
### Options:
###   --help
###
### after the system comes back up, re-enable a running hyperdrive environment

while IFS=$'\n' read UPSTREAM; do
  SHIP_IN_FORMATION="${UPSTREAM%.*}"
  if list_of_active_ships | fgrep -q -e "${SHIP_IN_FORMATION}"; then
    info "'${SHIP_IN_FORMATION}' restarting assignment"
  fi
done <<< "$(find "${HYPERDRIVE_NGINX}/upstream" -type f -iname 'hyperdrive-*.conf' -printf '%P\n')"

if status hyperdrive-nginx | fgrep -e 'stop/waiting'; then
  info 'starting hyperdrive-nginx'
  start hyperdrive-nginx 2>&1 | timestamped "${SCRIPT_NAME}" 30
else
  info 'reloading hyperdrive-nginx configs'
  reload hyperdrive-nginx 2>&1 | timestamped "${SCRIPT_NAME}" 30
fi
