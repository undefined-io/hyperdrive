# vi: set ft=upstart ts=2 et sw=2 sts=2 :
description "Keep a service running in a workstation"

env SCRIPT_NAME="starphleet-engineering-operate-workstation.conf"
env SLEEP=1

instance "${name}"

# respawn limit of at most 6 respawns in 70 seconds, if something is consistently wrong
respawn
respawn limit 6 70

# TODO: prevent job from runnign when invalid name is specified

script
  source "/etc/starphleet/main.conf" || exit 0
  SCRIPT_DIR="${STARPHLEET_ROOT}/scripts"
  source "${SCRIPT_DIR}/main.source" || exit 0

  exec "${STARPHLEET_SCRIPTS}/workstation-initiate" "${name}"

  trace "sleeping for ${SLEEP} seconds"
  sleep "${SLEEP}"
  # TODO: need to reset this to 1, when job has been running normally for a while
  SLEEP=$((SLEEP * 2))

  # this exit will force the respawn to keep the job running
  exit 1
end script
